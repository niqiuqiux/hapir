# Rust 项目注释规范

目标：注释必须提供“代码无法自解释的信息”，用于解释 **Why / Contract / Safety / Pitfalls / Links**；禁止脚手架式排版注释与复述代码。

## 0. 总原则（必须遵守）
1. 注释优先级：Why/约束/安全性/不变量/坑点/链接  >  使用示例  >  其他。
2. 不写“代码显而易见的 what 注释”（复述变量赋值、循环意义等）。
3. 不用注释做文件分区排版（禁止 `====`、`----` 等大段分隔线）。
4. 如果通过 **更好的命名/拆分函数/拆分模块** 能解决可读性，优先改结构而不是加注释。
5. 注释必须保持可维护：避免描述易变的实现细节；描述意图与契约。
6. 对外 API 的 Rustdoc 要能让使用者不读源码也能正确使用。
7. 出现 `unsafe` 时，必须写清“为什么是安全的”（Safety justification），否则不要写 `unsafe`。

---

## 1. 禁止项
- 任何“脚手架分隔线/章节横幅”注释，例如：
    - `// ============================================================================`
    - `// ----------------------------`
    - `// 公共类型定义` + 大段分隔线
- “占位式”注释：
    - `// TODO: optimize`（没有完成标准/链接/原因）
    - `// fix later`
    - `// magic happens here`
- 复述代码的注释：
    - `// increment i`
    - `// set flag to true`
- 泛化、无信息量评价：
    - `// simple`
    - `// hack`
    - `// workaround`（不解释 workaround 的原因与替代方案）

---

## 2. Rustdoc 位置规则（必须按语义使用）
- 文件/模块级说明：使用 `//!`（模块文档），放在文件顶部。
- item 文档（struct/enum/fn/trait/const）：使用 `///`。
- 行尾/块内实现细节：使用 `//`，仅在必要时写 Why/Safety/Pitfalls。

> 注意：不要用 `///` 来写“整个文件的用途”；应改用 `//!`。

---

## 3. 什么时候必须写注释？
### 3.1 公共 API（`pub`）必须写 Rustdoc
至少包含：
- 一句话概述（做什么）
- 参数/返回语义（不复述类型，而是写“含义与单位/约束”）
- 错误语义（何时返回哪类错误）
- 副作用（IO/网络/锁/阻塞/缓存）
- 复杂度或性能注意（如 O(n)、是否分配）
- 并发语义（Send/Sync、是否线程安全、是否幂等）

### 3.2 `unsafe` 块/函数必须写 Safety 说明
必须回答：
- 需要调用者保证什么前置条件？
- 本实现如何维持这些条件？
- 哪些不变量被依赖？

### 3.3 业务规则/反直觉逻辑必须写 Why
- 为什么这样做（约束/历史 bug/外部系统行为）
- 有无替代方案，为何没选（可简述）
- 规则来源链接（issue/ADR/文档）

---

## 4. 允许的注释模板
### 4.1 模块文档模板（文件顶部 `//!`）
```rust
//! <模块一句话用途>
//!
//! # Responsibilities
//! - <模块负责什么>
//! - <模块不负责什么（边界）>
//!
//! # Invariants
//! - <关键不变量/约束>
//!
//! # Performance
//! - <关键复杂度/分配/锁/阻塞说明（如有）>
//!
//! # Safety (if applicable)
//! - <unsafe/FFI 相关说明（如有）>
//!
//! # References
//! - <链接到 ADR / issue / 外部协议（如有）>
```

### 4.2 公共函数/类型 Rustdoc 模板（`///`）
```rust
/// <一句话做什么>
///
/// # Arguments
/// - `...`: <语义、范围、单位、是否允许空/0/None>
///
/// # Returns
/// <返回值语义，保证什么>
///
/// # Errors
/// <何时返回错误；错误代表什么>
/// 
/// # Panics
/// <如会 panic，说明条件；否则省略本节>
///
/// # Performance
/// <复杂度、分配、锁、阻塞等（如重要）>
///
/// # Examples
/// ```
/// <短小可运行示例（可选，重要 API 优先）>
/// ```
```

### 4.3 `unsafe` 安全性模板
```rust
// SAFETY: <一句话说明为什么此处 unsafe 是安全的>。
// - Precondition: <调用者需保证的条件（若在此处成立，也要说明为何成立）>
// - Invariants: <依赖的不变量>
// - Justification: <本实现如何确保/维持这些条件>
unsafe { ... }
```

### 4.4 TODO/FIXME 模板（仅当必要且可执行）
```rust
// TODO(<owner or team>, <issue-id>): <具体要做什么>。
// - Why: <为什么现在不做/有什么约束>
// - Done when: <完成标准/验收条件>
```

---

## 5. 注释强度（默认：最少注释）
- 默认不添加注释，除非满足“必须写注释”的条件。
- 若要加注释，优先加在：公共 API / unsafe / 反直觉逻辑处。
- 不为“分区排版”添加注释；分区应通过模块拆分与文件组织实现。

---

## 6. 输出约束
1. 不得自动添加文件横幅/章节分隔线。
2. 新增注释必须说明 Why/Contract/Safety/Pitfalls 中至少一项，否则删掉。
3. 修改现有线上代码时：除非注释明显错误或缺少 Safety，否则不要为了“好看”而重写注释风格。